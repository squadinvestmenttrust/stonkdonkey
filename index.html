<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stonk Donkey Terminal</title>
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --bb-black: #050505;
            --bb-orange: #ff9900;
            --bb-text: #e0e0e0;
            --bb-green: #00ff41;
            --bb-red: #ff3131;
            --bb-dim: #555555;
        }

        body {
            background-color: var(--bb-black);
            color: var(--bb-orange);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 10px; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }

        /* Scanline Overlay for CRT effect */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        header {
            border-bottom: 2px solid var(--bb-orange);
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        .header-left { text-align: left; }
        .header-right { 
            text-align: right; 
            max-width: 45%;
        }

        .terminal-text {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--bb-orange);
            text-shadow: 0 0 8px rgba(255, 153, 0, 0.6);
            line-height: 1;
        }

        #market-question {
            color: var(--bb-text);
            font-size: 0.75rem;
            margin-bottom: 2px;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        #market-answer-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0px;
        }

        #market-answer {
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1.1;
        }

        #portfolio-perf {
            font-size: 0.75rem;
            letter-spacing: 0;
            white-space: nowrap;
            margin-top: 2px;
        }

        #main-chart-wrapper {
            flex-grow: 1;
            width: 100%;
            border: 1px solid #222;
            position: relative;
            background: #000;
        }

        #chart-container {
            width: 100%;
            height: 100%;
        }

        /* Double Selector Wrapper */
        #selector-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 50;
            background: #111; 
            height: 30px; 
            display: flex;
            align-items: center;
            padding-left: 8px;
            gap: 15px;
        }

        .terminal-select-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .terminal-select-container::after {
            content: "▼";
            color: var(--bb-orange);
            font-size: 10px;
            margin-left: -12px;
            pointer-events: none;
        }

        select.terminal-select {
            background: transparent;
            color: var(--bb-orange);
            border: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            cursor: pointer;
            outline: none;
            padding-right: 15px;
            height: 30px;
            appearance: none;
            -webkit-appearance: none;
        }

        select.terminal-select option {
            background: var(--bb-black);
            color: var(--bb-orange);
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--bb-orange);
            font-size: 1rem;
            z-index: 10;
            text-align: center;
        }

        .pulse {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--bb-green);
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse-animation 2s infinite;
        }

        .ai-button {
            background: transparent;
            color: var(--bb-orange);
            border: 1px solid var(--bb-orange);
            padding: 4px 8px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 8px;
            text-transform: uppercase;
            font-weight: bold;
        }

        #ai-modal {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid var(--bb-orange);
            padding: 15px;
            z-index: 1000;
        }

        #ai-content {
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--bb-green);
        }

        @media (max-width: 480px) {
            .terminal-text { font-size: 1rem; }
            #market-answer { font-size: 1.5rem; }
            #selector-wrapper { gap: 8px; font-size: 11px; }
            select.terminal-select { font-size: 11px; }
        }

        @keyframes pulse-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes blink { 50% { opacity: 0; } }
        .blink { animation: blink 1s infinite; }
        .hoverlayer { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div id="market-question">MARKET_BEAT_STATUS:</div>
            <div id="market-answer-container">
                <span id="market-answer">INIT...</span>
                <span id="portfolio-perf"></span>
            </div>
        </div>
        <div class="header-right">
            <div class="terminal-text">STONK DONKEY</div>
            <div style="font-size:0.75rem; color:var(--bb-dim); margin-top:5px; white-space: nowrap;">
                <span class="pulse"></span>LIVE // <span id="last-update">--:--:--</span>
            </div>
            <button class="ai-button" onclick="runDonkeyBrain()">✨ AI_ANALYSIS</button>
        </div>
    </header>

    <div id="main-chart-wrapper">
        <div id="selector-wrapper">
            <div class="terminal-select-container">
                <select id="portfolio-selector" class="terminal-select">
                    <option value="personal">PERSONAL</option>
                    <option value="super">SUPER</option>
                </select>
            </div>
            <div class="terminal-select-container">
                <select id="view-mode-selector" class="terminal-select">
                    <option value="change">VIEW: RETURN</option>
                    <option value="pe">VIEW: P/E_RATIO</option>
                    <option value="eps">VIEW: EPS</option>
                </select>
            </div>
        </div>
        <div id="chart-container"></div>
        <div id="loading" class="blink">ESTABLISHING DATA LINK...</div>
    </div>

    <div id="ai-modal">
        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--bb-dim); border-bottom:1px dashed #333; margin-bottom:10px;">
            <span>DONKEY_BRAIN_V2.5</span>
            <span style="cursor:pointer; color:var(--bb-red)" onclick="document.getElementById('ai-modal').style.display='none'">[X]</span>
        </div>
        <div id="ai-content"></div>
    </div>

    <script>
        const apiKey = ""; 
        let currentPortfolioData = []; 

        const PORTFOLIOS = {
            personal: {
                name: "PERSONAL",
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRj4frRRj12rs9PbuIxwY6h6xyJHbxno1CQCUl2_fTek-CvKPnYYVwCZoa0t47qB-yzKSJKhU18dYcZ/pub?output=csv'
            },
            super: {
                name: "SUPER",
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vToyEpFcb9hlQvUTOUInofRf_o3Sc_-s_YYdF0LJXxOuPIuTvEO7X6ChlSSSH1u1k_nN1xRWfDJyVY7/pub?output=csv'
            }
        };

        function parseNumber(val) {
            if (val === undefined || val === null || val === '') return 0;
            const clean = val.toString().replace(/[^0-9.-]/g, '');
            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').innerText = now.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function fetchData() {
            const selection = document.getElementById('portfolio-selector').value;
            const config = PORTFOLIOS[selection];
            document.getElementById('loading').style.display = 'block';

            Papa.parse(config.url, {
                download: true,
                header: false,
                complete: function(results) {
                    processData(results.data, config.name);
                    updateTimestamp();
                },
                error: function(err) {
                    document.getElementById('market-answer').innerText = "LINK_ERR";
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }

        function processData(rows, portfolioName) {
            if (!rows || rows.length < 1) return;
            currentPortfolioData = rows;

            const mode = document.getElementById('view-mode-selector').value;

            // Header Logic
            const marketAnswer = rows[0][4]; 
            const answerEl = document.getElementById('market-answer');
            answerEl.innerText = marketAnswer ? marketAnswer.toUpperCase() : "N/A";
            const portPerf = rows[0][3];   
            const marketPerf = rows[0][2]; 
            const perfEl = document.getElementById('portfolio-perf');
            perfEl.innerText = (portPerf && marketPerf) ? `${portPerf} vs. ${marketPerf}` : (portPerf || "");
            
            const isGreen = marketAnswer && marketAnswer.toLowerCase().includes('yes');
            answerEl.style.color = isGreen ? 'var(--bb-green)' : 'var(--bb-red)';
            perfEl.style.color = isGreen ? 'var(--bb-green)' : 'var(--bb-red)';

            // Chart Logic
            let ids = [portfolioName];
            let labels = [portfolioName + "\u00A0\u00A0\u00A0\u00A0"];
            let parents = [""];
            let values = [0]; 
            let colors = [0]; 

            for (let i = 3; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 1) continue;
                const ticker = row[0];
                if (ticker && ticker.trim() !== "" && ticker !== "Ticker") {
                    const weight = parseNumber(row[3]); 
                    const changePct = parseNumber(row[4]);
                    const peVal = parseNumber(row[10]);
                    const epsVal = parseNumber(row[11]);

                    const displayWeight = Math.max(weight, 0.5);

                    // Determine what to display and color by
                    let displayVal, colorVal;
                    if (mode === 'pe') {
                        displayVal = `P/E: ${peVal}`;
                        colorVal = peVal; 
                    } else if (mode === 'eps') {
                        displayVal = `EPS: ${epsVal}`;
                        colorVal = epsVal;
                    } else {
                        displayVal = `${changePct}%`;
                        colorVal = changePct;
                    }

                    ids.push(ticker);
                    labels.push(`<b>${ticker}</b><br>${displayVal}`);
                    parents.push(portfolioName);
                    values.push(displayWeight); 
                    colors.push(colorVal);

                    // Detail View Alignment
                    const detailLines = [
                        `LAST_PRICE: ${row[6] || "-"}`,
                        `DAY_CHANGE: ${row[9] || "-"}`,
                        `DAY_HIGH:\u00A0\u00A0${row[7] || "-"}`,
                        `DAY_LOW:\u00A0\u00A0\u00A0${row[8] || "-"}`,
                        `P/E_RATIO:\u00A0${row[10] || "-"}`,
                        `EARNINGS:\u00A0\u00A0${row[11] || "-"}`
                    ];
                    let maxLen = 0;
                    detailLines.forEach(l => { if(l.length > maxLen) maxLen = l.length; });
                    const alignedText = detailLines.map(l => l + '\u00A0'.repeat(maxLen - l.length)).join('<br>');

                    ids.push(ticker + "_DETAIL");
                    labels.push(`<br><span style='font-size: 2.2em; font-weight:bold;'>${changePct}%</span><br><br><span style="font-size: 1.1em; line-height: 1.5;">${alignedText}</span>`);
                    parents.push(ticker); 
                    values.push(displayWeight); 
                    colors.push(colorVal); 
                }
            }

            renderChart(ids, labels, parents, values, colors, mode);
        }

        function renderChart(ids, labels, parents, values, colors, mode) {
            let colorscale;
            let cmid = null;

            if (mode === 'pe') {
                // High PE = Red/Expensive, Low PE = Green/Value
                colorscale = [[0, '#00cc00'], [0.2, '#33ff33'], [0.5, '#444'], [1, '#ff3131']];
            } else if (mode === 'eps') {
                // High EPS = Good
                colorscale = [[0, '#8B0000'], [0.5, '#444'], [1, '#00cc00']];
            } else {
                // Standard Returns
                colorscale = [[0, '#8B0000'], [0.45, '#3d0000'], [0.5, '#111111'], [0.55, '#003300'], [1, '#00cc00']];
                cmid = 0;
            }

            const data = [{
                type: 'treemap',
                ids: ids,
                labels: labels,
                parents: parents,
                values: values,
                marker: { 
                    colors: colors, 
                    colorscale: colorscale, 
                    cmid: cmid, 
                    line: { width: 2, color: '#050505' } // Fixed border color to terminal background black
                },
                textinfo: "label",
                hoverinfo: "skip",
                textfont: { family: 'Courier New', color: '#ffffff', size: 14 },
                tiling: { packing: "squarify", pad: 0 }, // Using internal lines for separation
                pathbar: { visible: true, bgcolor: "#111" },
                maxdepth: 2
            }];

            const layout = {
                margin: {t: 0, l: 0, r: 0, b: 0},
                paper_bgcolor: '#000000',
                plot_bgcolor: '#000000',
                font: { family: 'Courier New' }
            };

            document.getElementById('loading').style.display = 'none';
            Plotly.react('chart-container', data, layout, { responsive: true, displayModeBar: false });
        }

        async function fetchGemini(prompt, system) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: system }] }
            };
            
            let delays = [1000, 2000, 4000];
            for (let i = 0; i < 4; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error();
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    if (i === 3) throw e;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        async function runDonkeyBrain() {
            if (!currentPortfolioData || currentPortfolioData.length < 4) return;
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-content');
            modal.style.display = 'block';
            content.innerHTML = '<span class="blink">POLLING DONKEY_NODES...</span>';

            const summary = currentPortfolioData.slice(3).filter(r => r[0] && r[0] !== "Ticker").map(r => `${r[0]}: ${r[4]}%`).join(', ');
            const prompt = `Stats: ${currentPortfolioData[0][3]} vs Market ${currentPortfolioData[0][2]}. Beat: ${currentPortfolioData[0][4]}. Holdings: ${summary}`;
            const system = `You are "Stonk Donkey", a snarky 1980s AI broker. Roast or praise the user's daily performance in exactly 3 short sentences. Use terminal slang. No markdown. ALL CAPS for emphasis.`;

            try {
                const text = await fetchGemini(prompt, system);
                typeWriter(text || "MAINFRAME ERROR.", content);
            } catch (e) {
                content.innerHTML = '<span style="color:var(--bb-red)">LINK_FAILURE: API_KEY_NOT_INITIALIZED</span>';
            }
        }

        function typeWriter(text, el) {
            el.innerHTML = ""; let i = 0;
            const timer = setInterval(() => {
                if (i < text.length) { el.innerHTML += text.charAt(i); i++; }
                else { clearInterval(timer); el.innerHTML += '<span class="blink">_</span>'; }
            }, 30);
        }

        document.getElementById('portfolio-selector').addEventListener('change', fetchData);
        document.getElementById('view-mode-selector').addEventListener('change', fetchData);
        fetchData();
        setInterval(fetchData, 300000); 
    </script>
</body>
</html>

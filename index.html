<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stonk Donkey Terminal</title>
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --bb-black: #050505;
            --bb-orange: #ff9900;
            --bb-text: #e0e0e0;
            --bb-green: #00ff41;
            --bb-red: #ff3131;
            --bb-dim: #555555;
        }

        body {
            background-color: var(--bb-black);
            color: var(--bb-orange);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 10px; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }

        /* Scanline Overlay for CRT effect */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        header {
            border-bottom: 2px solid var(--bb-orange);
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        .header-left { text-align: left; }
        .header-right { 
            text-align: right; 
            max-width: 45%;
        }

        .terminal-text {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--bb-orange);
            text-shadow: 0 0 8px rgba(255, 153, 0, 0.6);
            line-height: 1;
        }

        #market-question {
            color: var(--bb-text);
            font-size: 0.75rem;
            margin-bottom: 2px;
            opacity: 0.8;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #market-answer-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0px;
        }

        #market-answer {
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1.1;
        }

        #portfolio-perf {
            font-size: 0.75rem;
            letter-spacing: 0;
            white-space: nowrap;
            margin-top: 2px;
        }

        /* Chart Wrapper */
        #main-chart-wrapper {
            flex-grow: 1;
            width: 100%;
            border: 1px solid #222;
            position: relative;
            background: #000;
        }

        #chart-container {
            width: 100%;
            height: 100%;
        }

        /* Floating Portfolio Selector matching Plotly Pathbar */
        #selector-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 50;
            background: #111; /* Matches Plotly pathbar bgcolor */
            height: 30px; 
            display: flex;
            align-items: center;
            padding-left: 8px; /* Matches internal pathbar spacing */
        }

        #portfolio-selector {
            background: transparent;
            color: var(--bb-orange);
            border: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            padding: 0 20px 0 0; /* Space for the chevron */
            height: 100%;
            appearance: none;
            -webkit-appearance: none;
        }

        #portfolio-selector option {
            background: var(--bb-black);
            color: var(--bb-orange);
        }

        #selector-wrapper::after {
            content: "▼";
            color: var(--bb-orange);
            font-size: 10px;
            position: absolute;
            right: 8px;
            pointer-events: none;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--bb-orange);
            font-size: 1rem;
            z-index: 10;
            text-align: center;
        }

        .pulse {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--bb-green);
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse-animation 2s infinite;
        }

        @media (max-width: 480px) {
            .terminal-text {
                font-size: 1rem;
            }
            #market-answer {
                font-size: 1.5rem;
            }
            .header-right div {
                font-size: 0.65rem !important;
            }
        }

        @keyframes pulse-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes blink { 50% { opacity: 0; } }
        .blink { animation: blink 1s infinite; }

        .js-plotly-plot .treemap-pathbar-text {
            font-family: 'Courier New' !important;
            fill: var(--bb-orange) !important;
        }

        .hoverlayer {
            display: none !important;
        }

        /* --- AI FEATURE CSS --- */
        .ai-button {
            background: transparent;
            color: var(--bb-orange);
            border: 1px solid var(--bb-orange);
            padding: 4px 8px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 8px;
            text-transform: uppercase;
            transition: all 0.2s;
            font-weight: bold;
        }
        .ai-button:hover {
            background: var(--bb-orange);
            color: var(--bb-black);
        }
        
        #ai-modal {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid var(--bb-orange);
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.15);
        }
        
        #ai-modal-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed var(--bb-dim);
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: var(--bb-dim);
        }
        
        #ai-close {
            cursor: pointer;
            color: var(--bb-red);
        }
        
        #ai-content {
            font-size: 1rem;
            line-height: 1.5;
            min-height: 60px;
            color: var(--bb-green);
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div id="market-question">MARKET_BEAT_STATUS:</div>
            <div id="market-answer-container">
                <span id="market-answer">INIT...</span>
                <span id="portfolio-perf"></span>
            </div>
        </div>
        <div class="header-right">
            <div class="terminal-text">STONK DONKEY</div>
            <div style="font-size:0.75rem; color:var(--bb-dim); margin-top:5px; white-space: nowrap;">
                <span class="pulse"></span>LIVE // <span id="last-update">--:--:--</span>
            </div>
            <button class="ai-button" onclick="runDonkeyBrain()">✨ AI_ANALYSIS</button>
        </div>
    </header>

    <div id="main-chart-wrapper">
        <div id="selector-wrapper">
            <select id="portfolio-selector">
                <option value="personal">PERSONAL</option>
                <option value="super">SUPER</option>
            </select>
        </div>
        <div id="chart-container"></div>
        <div id="loading" class="blink">ESTABLISHING DATA LINK...</div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal">
        <div id="ai-modal-header">
            <span>DONKEY_MAINFRAME_LINK ✨</span>
            <span id="ai-close" onclick="document.getElementById('ai-modal').style.display='none'">[X]</span>
        </div>
        <div id="ai-content"></div>
    </div>

    <script>
        const apiKey = ""; // Gemini API Key goes here
        let currentPortfolioData = []; // Stores data context for the AI

        const PORTFOLIOS = {
            personal: {
                name: "PERSONAL",
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRj4frRRj12rs9PbuIxwY6h6xyJHbxno1CQCUl2_fTek-CvKPnYYVwCZoa0t47qB-yzKSJKhU18dYcZ/pub?output=csv'
            },
            super: {
                name: "SUPER",
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vToyEpFcb9hlQvUTOUInofRf_o3Sc_-s_YYdF0LJXxOuPIuTvEO7X6ChlSSSH1u1k_nN1xRWfDJyVY7/pub?output=csv'
            }
        };

        function parseNumber(val) {
            if (val === undefined || val === null || val === '') return 0;
            const clean = val.toString().replace(/[^0-9.-]/g, '');
            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').innerText = now.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function fetchData() {
            const selection = document.getElementById('portfolio-selector').value;
            const config = PORTFOLIOS[selection];
            
            document.getElementById('loading').style.display = 'block';
            console.log(`Fetching data for: ${config.name}`);

            Papa.parse(config.url, {
                download: true,
                header: false,
                complete: function(results) {
                    processData(results.data, config.name);
                    updateTimestamp();
                },
                error: function(err) {
                    document.getElementById('market-answer').innerText = "LINK_ERR";
                    document.getElementById('market-answer').style.color = 'var(--bb-red)';
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }

        function processData(rows, portfolioName) {
            if (!rows || rows.length < 1) return;

            currentPortfolioData = rows; // Save state for AI analysis

            // --- HEADER LOGIC ---
            const marketAnswer = rows[0][4]; // E1
            const answerEl = document.getElementById('market-answer');
            answerEl.innerText = marketAnswer ? marketAnswer.toUpperCase() : "N/A";
            
            const portPerf = rows[0][3];   // D1
            const marketPerf = rows[0][2]; // C1
            const perfEl = document.getElementById('portfolio-perf');
            
            if (portPerf && marketPerf) {
                perfEl.innerText = `${portPerf} vs. ${marketPerf}`;
            } else if (portPerf) {
                perfEl.innerText = `${portPerf}`;
            } else {
                perfEl.innerText = "";
            }

            if(marketAnswer && marketAnswer.toLowerCase().includes('yes')) {
                answerEl.style.color = 'var(--bb-green)';
                perfEl.style.color = 'var(--bb-green)';
            } else {
                answerEl.style.color = 'var(--bb-red)';
                perfEl.style.color = 'var(--bb-red)';
            }

            // --- CHART LOGIC ---
            // Pad the label slightly so Plotly leaves enough space for our dropdown arrow
            const paddedLabel = portfolioName + "\u00A0\u00A0\u00A0\u00A0";
            
            let ids = [portfolioName];
            let labels = [paddedLabel];
            let parents = [""];
            let values = [0]; 
            let colors = [0]; 

            for (let i = 3; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 1) continue;

                const ticker = row[0];
                if (ticker && ticker.trim() !== "" && ticker !== "Ticker") {
                    const rawWeight = parseNumber(row[3]); 
                    const changePct = parseNumber(row[4]); 
                    const displayValue = Math.max(rawWeight, 0.5);

                    const price = row[6] || "-";
                    const high = row[7] || "-";
                    const low = row[8] || "-";
                    const changeAbs = row[9] || "-";
                    const pe = row[10] || "-";
                    const eps = row[11] || "-";

                    ids.push(ticker);
                    labels.push(`<b>${ticker}</b><br>${changePct}%`);
                    parents.push(portfolioName);
                    values.push(displayValue); 
                    colors.push(changePct);

                    const detailLines = [
                        `LAST_PRICE: ${price}`,
                        `DAY_CHANGE: ${changeAbs}`,
                        `DAY_HIGH:\u00A0\u00A0${high}`,
                        `DAY_LOW:\u00A0\u00A0\u00A0${low}`,
                        `P/E_RATIO:\u00A0${pe}`,
                        `EARNINGS:\u00A0\u00A0${eps}`
                    ];
                    
                    let maxLen = 0;
                    detailLines.forEach(l => { if(l.length > maxLen) maxLen = l.length; });
                    const alignedText = detailLines.map(l => l + '\u00A0'.repeat(maxLen - l.length)).join('<br>');

                    const detailId = ticker + "_DETAIL";
                    const detailText = `
                        <br>
                        <span style='font-size: 2.2em; font-weight:bold;'>${changePct}%</span><br>
                        <br>
                        <span style="font-size: 1.1em; line-height: 1.5; font-family: 'Courier New'">
                        ${alignedText}
                        </span>
                    `;

                    ids.push(detailId);
                    labels.push(detailText); 
                    parents.push(ticker); 
                    values.push(displayValue); 
                    colors.push(changePct); 
                }
            }

            renderChart(ids, labels, parents, values, colors);
        }

        function renderChart(ids, labels, parents, values, colors) {
            const data = [{
                type: 'treemap',
                ids: ids,
                labels: labels,
                parents: parents,
                values: values,
                marker: {
                    colors: colors,
                    colorscale: [
                        [0, '#8B0000'],    // Dark Red
                        [0.45, '#3d0000'], // Muted Red
                        [0.5, '#111111'],  // Black/Neutral
                        [0.55, '#003300'], // Muted Green
                        [1, '#00cc00']     // Bright Green
                    ],
                    cmid: 0,
                    line: { width: 1, color: '#050505' } 
                },
                textinfo: "label",
                hoverinfo: "skip",
                textfont: { family: 'Courier New', color: '#ffffff', size: 14 },
                tiling: { packing: "squarify", pad: 1 },
                pathbar: { visible: true, bgcolor: "#111" },
                maxdepth: 2
            }];

            const layout = {
                margin: {t: 0, l: 0, r: 0, b: 0},
                paper_bgcolor: '#000000',
                plot_bgcolor: '#000000',
                font: { family: 'Courier New', color: '#ff9900' }
            };

            document.getElementById('loading').style.display = 'none';
            
            Plotly.react('chart-container', data, layout, {
                responsive: true, 
                displayModeBar: false
            });
        }

        // Event listener for portfolio switch
        document.getElementById('portfolio-selector').addEventListener('change', fetchData);

        // Initial fetch
        fetchData();
        
        // Auto-refresh every 5 minutes
        setInterval(fetchData, 300000); 

        // --- GEMINI AI INTEGRATION ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        async function runDonkeyBrain() {
            if (!currentPortfolioData || currentPortfolioData.length < 4) return;
            
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-content');
            modal.style.display = 'block';
            content.innerHTML = '<span class="blink">TRANSMITTING PORTFOLIO DATA TO DONKEY MAINFRAME...</span>';

            // Gather stats for the LLM
            const marketAnswer = currentPortfolioData[0][4] || "N/A";
            const portPerf = currentPortfolioData[0][3] || "N/A";
            const marketPerf = currentPortfolioData[0][2] || "N/A";
            
            let stockSummary = [];
            for(let i=3; i<currentPortfolioData.length; i++) {
                const row = currentPortfolioData[i];
                if(row[0] && row[0] !== "Ticker") {
                    stockSummary.push(`${row[0]}: ${row[4]}%`);
                }
            }

            const promptText = `Analyze this daily portfolio update:
Performance: ${portPerf} (Market: ${marketPerf})
Beat Market: ${marketAnswer}
Holdings: ${stockSummary.join(', ')}`;

            const systemPrompt = `You are "Stonk Donkey", a cynical, retro 1980s AI stock broker terminal. 
Provide a quick, snarky 3-sentence analysis of the user's daily portfolio performance based on the provided data. 
Be ruthless if they lost to the market, and mockingly impressed if they won. Call out specific stocks if they dragged the portfolio down or carried it.
Use ALL CAPS occasionally and terminal/hacker slang (e.g., //, ERROR, OVERRIDE, NOOB). 
Keep it very short. Do not use asterisks or markdown formatting in your response.`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: promptText }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "ERROR: DONKEY BRAIN OFFLINE.";
                typeWriterEffect(responseText, content);
            } catch (error) {
                content.innerHTML = `<span style="color:var(--bb-red)">CONNECTION TERMINATED. // GEMINI API KEY MISSING OR INVALID.</span>`;
            }
        }

        function typeWriterEffect(text, element, speed = 25) {
            element.innerHTML = "";
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    element.innerHTML += '<span class="blink">_</span>';
                }
            }
            type();
        }
    </script>
</body>
</html>

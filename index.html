<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stonk Donkey Terminal</title>
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --bb-black: #050505;
            --bb-orange: #ff9900;
            --bb-text: #e0e0e0;
            --bb-green: #00ff41;
            --bb-red: #ff3131;
            --bb-dim: #555555;
        }

        body {
            background-color: var(--bb-black);
            color: var(--bb-orange);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 15px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
            /* Prevent grey highlight on mobile tap */
            -webkit-tap-highlight-color: transparent;
        }

        /* Scanline Overlay for CRT effect */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        header {
            border-bottom: 2px solid var(--bb-orange);
            padding-bottom: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .header-left { text-align: left; }
        .header-right { text-align: right; }

        .terminal-text {
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--bb-orange);
            text-shadow: 0 0 8px rgba(255, 153, 0, 0.6);
        }

        #market-question {
            color: var(--bb-text);
            font-size: 0.85rem;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        #market-answer-container {
            font-size: 2.2rem;
            font-weight: bold;
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        #portfolio-perf {
            font-size: 0.6em;
            letter-spacing: 0;
            white-space: nowrap;
        }

        #chart-container {
            flex-grow: 1;
            width: 100%;
            border: 1px solid #222;
            position: relative;
            background: #000;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--bb-orange);
            font-size: 1.2rem;
            z-index: 10;
            text-align: center;
        }

        .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--bb-green);
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse-animation 2s infinite;
        }

        @keyframes pulse-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes blink { 50% { opacity: 0; } }
        .blink { animation: blink 1s infinite; }

        /* Customizing Plotly UI */
        .js-plotly-plot .treemap-pathbar-text {
            font-family: 'Courier New' !important;
            fill: var(--bb-orange) !important;
        }

        /* Brutally remove any Plotly hover tooltips/boxes */
        .hoverlayer {
            display: none !important;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div id="market-question">MARKET_BEAT_STATUS:</div>
            <div id="market-answer-container">
                <span id="market-answer">INIT...</span>
                <span id="portfolio-perf"></span>
            </div>
        </div>
        <div class="header-right">
            <div class="terminal-text">STONK DONKEY</div>
            <div style="font-size:0.8em; color:var(--bb-dim); margin-top:5px;">
                <span class="pulse"></span>SYSTEM_LIVE // <span id="last-update">--:--:--</span>
            </div>
        </div>
    </header>

    <div id="chart-container">
        <div id="loading" class="blink">ESTABLISHING DATA LINK...</div>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRj4frRRj12rs9PbuIxwY6h6xyJHbxno1CQCUl2_fTek-CvKPnYYVwCZoa0t47qB-yzKSJKhU18dYcZ/pub?output=csv';

        function parseNumber(val) {
            if (val === undefined || val === null || val === '') return 0;
            const clean = val.toString().replace(/[^0-9.-]/g, '');
            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').innerText = now.toLocaleTimeString([], { hour12: false });
        }

        function fetchData() {
            console.log("Fetching fresh stonk data...");
            Papa.parse(SHEET_URL, {
                download: true,
                header: false,
                complete: function(results) {
                    processData(results.data);
                    updateTimestamp();
                },
                error: function(err) {
                    document.getElementById('market-answer').innerText = "LINK_ERR";
                    document.getElementById('market-answer').style.color = 'var(--bb-red)';
                }
            });
        }

        function processData(rows) {
            if (!rows || rows.length < 1) return;

            // --- HEADER LOGIC ---
            const marketAnswer = rows[0][4]; // E1
            const answerEl = document.getElementById('market-answer');
            answerEl.innerText = marketAnswer ? marketAnswer.toUpperCase() : "N/A";
            
            const portPerf = rows[0][3];   // D1
            const marketPerf = rows[0][2]; // C1
            const perfEl = document.getElementById('portfolio-perf');
            
            // Build the string: (D1 vs. C1)
            if (portPerf && marketPerf) {
                perfEl.innerText = `(${portPerf} vs. ${marketPerf})`;
            } else if (portPerf) {
                perfEl.innerText = `(${portPerf})`;
            } else {
                perfEl.innerText = "";
            }

            // Dynamic Coloring
            if(marketAnswer && marketAnswer.toLowerCase().includes('yes')) {
                answerEl.style.color = 'var(--bb-green)';
                perfEl.style.color = 'var(--bb-green)';
            } else {
                answerEl.style.color = 'var(--bb-red)';
                perfEl.style.color = 'var(--bb-red)';
            }

            // --- CHART LOGIC ---
            let ids = ["PORTFOLIO"];
            let labels = ["PORTFOLIO"];
            let parents = [""];
            let values = [0]; 
            let colors = [0]; 

            for (let i = 3; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 1) continue;

                const ticker = row[0];
                if (ticker && ticker.trim() !== "" && ticker !== "Ticker") {
                    const rawWeight = parseNumber(row[3]); 
                    const changePct = parseNumber(row[4]); 
                    const displayValue = Math.max(rawWeight, 0.5);

                    const price = row[6] || "-";
                    const high = row[7] || "-";
                    const low = row[8] || "-";
                    const changeAbs = row[9] || "-";
                    const pe = row[10] || "-";
                    const eps = row[11] || "-";

                    ids.push(ticker);
                    labels.push(`<b>${ticker}</b><br>${changePct}%`);
                    parents.push("PORTFOLIO");
                    values.push(displayValue); 
                    colors.push(changePct);

                    const detailLines = [
                        `LAST_PRICE: ${price}`,
                        `DAY_CHANGE: ${changeAbs}`,
                        `DAY_HIGH:\u00A0\u00A0${high}`,
                        `DAY_LOW:\u00A0\u00A0\u00A0${low}`,
                        `P/E_RATIO:\u00A0${pe}`,
                        `EARNINGS:\u00A0\u00A0${eps}`
                    ];
                    
                    let maxLen = 0;
                    detailLines.forEach(l => { if(l.length > maxLen) maxLen = l.length; });
                    const alignedText = detailLines.map(l => l + '\u00A0'.repeat(maxLen - l.length)).join('<br>');

                    const detailId = ticker + "_DETAIL";
                    const detailText = `
                        <br>
                        <span style='font-size: 2.2em; font-weight:bold;'>${changePct}%</span><br>
                        <br>
                        <span style="font-size: 1.1em; line-height: 1.5; font-family: 'Courier New'">
                        ${alignedText}
                        </span>
                    `;

                    ids.push(detailId);
                    labels.push(detailText); 
                    parents.push(ticker); 
                    values.push(displayValue); 
                    colors.push(changePct); 
                }
            }

            renderChart(ids, labels, parents, values, colors);
        }

        function renderChart(ids, labels, parents, values, colors) {
            const data = [{
                type: 'treemap',
                ids: ids,
                labels: labels,
                parents: parents,
                values: values,
                marker: {
                    colors: colors,
                    colorscale: [
                        [0, '#8B0000'],    // Dark Red
                        [0.45, '#3d0000'], // Muted Red
                        [0.5, '#111111'],  // Black/Neutral
                        [0.55, '#003300'], // Muted Green
                        [1, '#00cc00']     // Bright Green
                    ],
                    cmid: 0,
                    line: { width: 1, color: '#050505' } 
                },
                textinfo: "label",
                hoverinfo: "skip",
                textfont: { family: 'Courier New', color: '#ffffff', size: 14 },
                tiling: { packing: "squarify", pad: 1 },
                pathbar: { visible: true, bgcolor: "#111" },
                maxdepth: 2
            }];

            const layout = {
                margin: {t: 0, l: 0, r: 0, b: 0},
                paper_bgcolor: '#000000',
                plot_bgcolor: '#000000',
                font: { family: 'Courier New', color: '#ff9900' }
            };

            document.getElementById('loading').style.display = 'none';
            
            Plotly.react('chart-container', data, layout, {
                responsive: true, 
                displayModeBar: false
            });
        }

        fetchData();
        setInterval(fetchData, 300000); 
    </script>
</body>
</html>
